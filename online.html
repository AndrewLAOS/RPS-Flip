<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Online Whimsical RPS Duel</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet" />
<style>
  /* Your styles as provided - omitted here for brevity */
  /* (Include your entire CSS here) */
  /* ... */
</style>
</head>
<body>
  <div id="container" role="main" aria-label="Online Whimsical Rock Paper Scissors Duel Game">
    <h1>Whimsical RPS Duel Online</h1>
    <p class="subtitle">Play against friends or bots with dramatic card flips!</p>

    <div id="login-section" aria-live="polite">
      <button id="btnGoogleLogin">Sign in with Google</button>
      <p id="login-status"></p>
    </div>

    <div id="match-section" hidden>
      <button id="btnCreateMatch">Create New Match</button>
      <br/><br/>
      <label for="match-id-input">Enter Match ID to Join:</label><br/>
      <input type="text" id="match-id-input" maxlength="10" placeholder="e.g. ABC123" autocomplete="off" aria-label="Match ID input" />
      <button id="btnJoinMatch">Join Match</button>
      <p id="match-status" style="font-weight:600; margin-top:1rem;"></p>
      <!-- This is where we will display the created match code -->
      <p id="generated-match-id" style="font-weight:700; margin-top:1rem;"></p>
    </div>

    <div id="game-section" hidden aria-live="polite" aria-atomic="true">
      <div class="player-area" aria-label="Players area">
        <div class="player-card" aria-label="Your card">
          <div class="card-inner" id="player-card-inner">
            <div class="card-front">?</div>
            <div class="card-back" id="player-card-back"></div>
          </div>
          <div class="player-name" id="player-name-label"></div>
        </div>
        <div class="player-card" aria-label="Opponent card">
          <div class="card-inner" id="opponent-card-inner">
            <div class="card-front">?</div>
            <div class="card-back" id="opponent-card-back"></div>
          </div>
          <div class="player-name" id="opponent-name-label"></div>
        </div>
      </div>

      <div id="choices" role="list" aria-label="Choose your item to play"></div>

      <div id="status-text" role="status"></div>
    </div>

    <div id="loading-spinner" aria-hidden="true" role="img" aria-label="Loading spinner"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Initialize Firebase (compat)
    const firebaseConfig = {
      apiKey: "AIzaSyAqmG4OxLp7f1kktoLwicGR4O2SLwqNBk0",
      authDomain: "rps-flip.firebaseapp.com",
      projectId: "rps-flip",
      storageBucket: "rps-flip.appspot.com",
      messagingSenderId: "1044307931173",
      appId: "1:1044307931173:web:efa8c8bcf4cd82c1e14fcc",
      measurementId: "G-57Z3NG9FJN"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const ITEMS = {
      rock: { icon: '✊', name: 'Rock', beats: ['scissors', 'fire'] },
      paper: { icon: '✋', name: 'Paper', beats: ['rock', 'robot'] },
      scissors: { icon: '✌️', name: 'Scissors', beats: ['paper', 'water'] },
      fire: { icon: '🔥', name: 'Fire', beats: ['paper', 'robot'] },
      water: { icon: '💧', name: 'Water', beats: ['rock', 'fire'] },
      robot: { icon: '🤖', name: 'Robot', beats: ['scissors', 'water'] }
    };

    // Elements
    const loginSection = document.getElementById('login-section');
    const btnGoogleLogin = document.getElementById('btnGoogleLogin');
    const loginStatus = document.getElementById('login-status');

    const matchSection = document.getElementById('match-section');
    const btnCreateMatch = document.getElementById('btnCreateMatch');
    const matchIdInput = document.getElementById('match-id-input');
    const btnJoinMatch = document.getElementById('btnJoinMatch');
    const matchStatus = document.getElementById('match-status');
    const generatedMatchIdDisplay = document.getElementById('generated-match-id');

    const gameSection = document.getElementById('game-section');
    const playerCardInner = document.getElementById('player-card-inner');
    const playerCardBack = document.getElementById('player-card-back');
    const opponentCardInner = document.getElementById('opponent-card-inner');
    const opponentCardBack = document.getElementById('opponent-card-back');
    const playerNameLabel = document.getElementById('player-name-label');
    const opponentNameLabel = document.getElementById('opponent-name-label');
    const choicesDiv = document.getElementById('choices');
    const statusText = document.getElementById('status-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    // Game state
    let currentUser = null;
    let matchId = null;
    let playerNumber = null;
    let opponentId = null;
    let gameRef = null;

    // Google sign-in
    btnGoogleLogin.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        loginStatus.textContent = 'Login failed: ' + err.message;
      });
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginStatus.textContent = `Hello, ${user.displayName}!`;
        loginSection.hidden = true;
        matchSection.hidden = false;
        generatedMatchIdDisplay.textContent = '';
        matchStatus.textContent = '';
        btnCreateMatch.disabled = false;
        btnJoinMatch.disabled = false;
        matchIdInput.disabled = false;
      } else {
        currentUser = null;
        loginStatus.textContent = '';
        loginSection.hidden = false;
        matchSection.hidden = true;
        gameSection.hidden = true;
      }
    });

    // Generate a simple 6-char match ID (A-Z0-9)
    function generateMatchId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let id = '';
      for(let i=0; i<6; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    // Create new match
    btnCreateMatch.addEventListener('click', async () => {
      if (!currentUser) {
        matchStatus.textContent = 'Please sign in first.';
        return;
      }
      btnCreateMatch.disabled = true;
      btnJoinMatch.disabled = true;
      matchIdInput.disabled = true;
      matchStatus.textContent = '';
      generatedMatchIdDisplay.textContent = '';

      loadingSpinner.style.display = 'block';

      // Keep trying until unique ID found
      let newMatchId;
      while (true) {
        newMatchId = generateMatchId();
        const snap = await db.ref(`matches/${newMatchId}`).once('value');
        if (!snap.exists()) break;
      }

      // Create match
      gameRef = db.ref(`matches/${newMatchId}`);
      await gameRef.set({
        player1: {
          uid: currentUser.uid,
          name: currentUser.displayName,
          choice: null,
          score: 0,
        },
        player2: null,
        turn: 'player1',
        result: null,
        started: false,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
      });

      matchId = newMatchId;
      playerNumber = 'player1';
      opponentId = 'player2';

      generatedMatchIdDisplay.textContent = `Match created! Share this code: ${newMatchId}`;
      matchStatus.textContent = '';

      loadingSpinner.style.display = 'none';

      matchSection.hidden = true;
      gameSection.hidden = false;

      setupGameUI();
      listenForGameUpdates();
    });

    // Join existing match by ID
    btnJoinMatch.addEventListener('click', () => {
      const enteredId = matchIdInput.value.trim().toUpperCase();
      if (!enteredId) {
        matchStatus.textContent = 'Please enter a Match ID to join.';
        return;
      }
      startMatch(enteredId);
    });

    // Start or join a match by ID
    async function startMatch(id) {
      loadingSpinner.style.display = 'block';
      matchStatus.textContent = `Joining match ${id}...`;
      btnCreateMatch.disabled = true;
      btnJoinMatch.disabled = true;
      matchIdInput.disabled = true;

      gameRef = db.ref(`matches/${id}`);
      const snap = await gameRef.once('value');
      const matchData = snap.val();

      if (!matchData) {
        matchStatus.textContent = `Match ID "${id}" not found.`;
        loadingSpinner.style.display = 'none';
        btnCreateMatch.disabled = false;
        btnJoinMatch.disabled = false;
        matchIdInput.disabled = false;
        return;
      }

      if (!matchData.player2) {
        // Join as player2
        await gameRef.update({
          player2: {
            uid: currentUser.uid,
            name: currentUser.displayName,
            choice: null,
            score: 0,
          },
          started: true,
          turn: 'player1',
          result: null
        });
        playerNumber = 'player2';
        opponentId = 'player1';
      } else if (matchData.player1.uid === currentUser.uid) {
        playerNumber = 'player1';
        opponentId = 'player2';
      } else if (matchData.player2.uid === currentUser.uid) {
        playerNumber = 'player2';
        opponentId = 'player1';
      } else {
        matchStatus.textContent = 'Match is full. Try another ID.';
        loadingSpinner.style.display = 'none';
        btnCreateMatch.disabled = false;
        btnJoinMatch.disabled = false;
        matchIdInput.disabled = false;
        return;
      }

      matchId = id;
      generatedMatchIdDisplay.textContent = '';
      matchStatus.textContent = `Joined match ${id} as ${playerNumber.toUpperCase()}`;
      loadingSpinner.style.display = 'none';

      matchSection.hidden = true;
      gameSection.hidden = false;

      setupGameUI();
      listenForGameUpdates();
    }

    // Setup game UI elements
    function setupGameUI() {
      playerNameLabel.textContent = currentUser.displayName;
      opponentNameLabel.textContent = 'Waiting for opponent...';
      clearChoices();

      for (const key in ITEMS) {
        const item = ITEMS[key];
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.setAttribute('role', 'listitem');
        btn.setAttribute('aria-label', `Choose ${item.name}`);
        btn.innerHTML = `${item.icon}<div class="choice-label">${item.name}</div>`;
        btn.onclick = () => {
          makeChoice(key);
        };
        choicesDiv.appendChild(btn);
      }
      updateStatus('Waiting for opponent to join...');
    }

    function clearChoices() {
      choicesDiv.innerHTML = '';
    }

    // Listen for realtime game updates
    function listenForGameUpdates() {
      if (!gameRef) return;
      gameRef.on('value', snapshot => {
        const data = snapshot.val();
        if (!data) {
          updateStatus('Match ended or does not exist.');
          gameSection.hidden = true;
          matchSection.hidden = false;
          btnCreateMatch.disabled = false;
          btnJoinMatch.disabled = false;
          matchIdInput.disabled = false;
          return;
        }
        if (!data.player2) {
          opponentNameLabel.textContent = 'Waiting for opponent...';
          updateStatus('Waiting for opponent to join...');
          disableChoices(true);
          return;
        } else {
          opponentNameLabel.textContent = data[opponentId]?.name || 'Opponent';
        }

        const playerData = data[playerNumber];
        const opponentData = data[opponentId];

        updateCard(playerCardInner, playerCardBack, playerData?.choice);
        updateCard(opponentCardInner, opponentCardBack, opponentData?.choice);

        if (playerData.choice && opponentData.choice) {
          const result = getResult(playerData.choice, opponentData.choice);
          updateStatusResult(result);
          disableChoices(true);

          setTimeout(() => {
            gameRef.update({
              [`${playerNumber}/choice`]: null,
              [`${opponentId}/choice`]: null,
              result: null,
              turn: 'player1'
            });
            clearFlipAnimations();
            updateStatus('Your turn!');
            disableChoices(false);
          }, 3000);
        } else {
          if (data.turn === playerNumber) {
            updateStatus("Your turn! Choose an item.");
            disableChoices(false);
          } else {
            updateStatus("Opponent's turn, please wait...");
            disableChoices(true);
          }
        }
      });
    }

    function updateCard(cardInner, cardBack, choice) {
      if (!choice) {
        cardBack.textContent = '';
        cardInner.classList.remove('flipped');
      } else {
        cardBack.textContent = ITEMS[choice].icon;
        if (!cardInner.classList.contains('flipped')) {
          cardInner.classList.add('flipped');
          cardBack.classList.add('animate-flip');
          setTimeout(() => {
            cardBack.classList.remove('animate-flip');
          }, 800);
        }
      }
    }

    function clearFlipAnimations() {
      playerCardInner.classList.remove('flipped');
      opponentCardInner.classList.remove('flipped');
    }

    function disableChoices(disable) {
      const buttons = choicesDiv.querySelectorAll('button.choice');
      buttons.forEach(btn => btn.disabled = disable);
    }

    function makeChoice(choiceKey) {
      disableChoices(true);
      updateStatus('Waiting for opponent...');
      gameRef.once('value').then(snapshot => {
        const data = snapshot.val();
        if (data.turn !== playerNumber) {
          updateStatus('Not your turn!');
          disableChoices(false);
          return;
        }
        gameRef.update({
          [`${playerNumber}/choice`]: choiceKey,
          turn: opponentId
        });
      });
    }

    function getResult(p1Choice, p2Choice) {
      if (p1Choice === p2Choice) return 'tie';
      if (ITEMS[p1Choice].beats.includes(p2Choice)) return 'win';
      return 'lose';
    }

    function updateStatusResult(result) {
      if (result === 'win') {
        statusText.textContent = 'You Win! 🎉';
        statusText.className = 'win-text';
      } else if (result === 'lose') {
        statusText.textContent = 'You Lose! 😞';
        statusText.className = 'lose-text';
      } else {
        statusText.textContent = "It's a Tie! 😐";
        statusText.className = 'tie-text';
      }
    }

    function updateStatus(text) {
      statusText.textContent = text;
      statusText.className = '';
    }
  </script>
</body>
</html>
