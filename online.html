<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online RPS Flip</title>
<style>
  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background: linear-gradient(to right, #1e1e2e, #282a36);
    color: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  section { 
    width: 90%; 
    max-width: 600px; 
    text-align: center; 
    margin-top: 40px;
  }
  button {
    background-color: #ff6f61;
    border: none;
    color: white;
    padding: 12px 24px;
    margin: 6px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover { background-color: #ff4b3a; }
  input {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-right: 6px;
    font-size: 16px;
    width: 180px;
  }
  .scoreboard {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
  }
  .card {
    width: 80px; height: 80px;
    border: 2px solid #fff;
    border-radius: 12px;
    font-size: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px auto;
    background: #2c2f42;
  }
  #choices {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin: 20px 0;
  }
  .choice {
    margin: 8px;
    font-size: 32px;
    width: 80px;
    height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: 2px solid #fff;
    background: #3b3f58;
    cursor: pointer;
  }
  .choice-label {
    font-size: 12px;
    margin-top: 4px;
  }
  #status-text { font-size: 18px; margin-top: 10px; }
</style>
</head>
<body>

<section id="login-section">
  <p id="login-status"></p>
  <button id="btnGoogleLogin">Sign in with Google</button>
  <button id="btnBackToBotLogin">Back to Bot</button>
</section>

<section id="match-section" hidden>
  <button id="btnCreateMatch">Create Match</button>
  <div>
    <input type="text" id="match-id-input" placeholder="Enter Match ID">
    <button id="btnJoinMatch">Join Match</button>
  </div>
  <p id="generated-match-id"></p>
  <p id="match-status"></p>
  <button id="btnBackToBotMatch">Back to Bot</button>
</section>

<section id="game-section" hidden>
  <div class="scoreboard">
    <div>
      <div id="player-name-label">Player</div>
      <div class="card" id="player-card-inner"><span class="card-front">?</span></div>
      <div>Score: <span id="player-score">0</span></div>
    </div>
    <div>
      <div id="opponent-name-label">Opponent</div>
      <div class="card" id="opponent-card-inner"><span class="card-front">?</span></div>
      <div>Score: <span id="opponent-score">0</span></div>
    </div>
  </div>

  <div id="choices"></div>
  <p id="status-text">Sign in to start playing!</p>
  <button id="btnLeaveMatch">Leave Match</button>
  <button id="btnBackToBotGame">Back to Bot</button>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script type="module">
import { items, itemKeys } from './items.js';

const $ = (sel, root=document) => root.querySelector(sel);

// DOM
const loginSection = $('#login-section');
const matchSection = $('#match-section');
const gameSection = $('#game-section');
const btnGoogleLogin = $('#btnGoogleLogin');
const loginStatus = $('#login-status');

const btnCreateMatch = $('#btnCreateMatch');
const btnJoinMatch = $('#btnJoinMatch');
const matchIdInput = $('#match-id-input');
const matchStatus = $('#match-status');
const generatedMatchId = $('#generated-match-id');

const playerCardInner = $('#player-card-inner');
const opponentCardInner = $('#opponent-card-inner');
const playerNameLabel = $('#player-name-label');
const opponentNameLabel = $('#opponent-name-label');
const playerScoreEl = $('#player-score');
const opponentScoreEl = $('#opponent-score');

const choicesDiv = $('#choices');
const statusText = $('#status-text');

const btnLeaveMatch = $('#btnLeaveMatch');

// Back to Bot buttons
const backToBotButtons = [
  $('#btnBackToBotLogin'),
  $('#btnBackToBotMatch'),
  $('#btnBackToBotGame')
];
backToBotButtons.forEach(btn => btn.onclick = () => window.location.href='bot.html');

// Game state
let state = {
  playerId: null,
  playerName: '',
  matchId: null,
  choices: new Set(itemKeys),
  playerChoice: null,
  opponentChoice: null,
  playerScore: 0,
  opponentScore: 0,
  matchRef: null,
};

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAqmG4OxLp7f1kktoLwicGR4O2SLwqNBk0",
  authDomain: "rps-flip.firebaseapp.com",
  projectId: "rps-flip",
  storageBucket: "rps-flip.appspot.com",
  messagingSenderId: "1044307931173",
  appId: "1:1044307931173:web:efa8c8bcf4cd82c1e14fcc"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Google Sign In
btnGoogleLogin.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    const user = result.user;
    state.playerId = user.uid;
    state.playerName = user.displayName || 'Player';
    loginSection.hidden = true;
    matchSection.hidden = false;
    loginStatus.textContent = `Logged in as ${state.playerName}`;
  } catch (err) {
    alert('Login failed: '+err.message);
  }
};

// Generate Match ID
function generateMatchId(length=6) {
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let str='';
  for(let i=0;i<length;i++) str+=chars[Math.floor(Math.random()*chars.length)];
  return str;
}

// Create/Join Match
btnCreateMatch.onclick = async () => {
  const id = generateMatchId();
  state.matchId = id;
  generatedMatchId.textContent = `Match ID: ${id}`;
  matchStatus.textContent = 'Waiting for opponent...';
  gameSection.hidden = false;
  matchSection.hidden = true;

  const matchRef = db.ref('matches/' + id);
  state.matchRef = matchRef;

  await matchRef.set({
    players:{[state.playerId]:{name:state.playerName,score:0,choice:null}},
    createdAt:Date.now()
  });

  matchRef.on('value', snap => handleMatchUpdate(snap.val()));
  renderChoices();
};

btnJoinMatch.onclick = async () => {
  const id = matchIdInput.value.trim().toUpperCase();
  if(!id) return alert('Enter a valid Match ID');
  state.matchId = id;
  const matchRef = db.ref('matches/' + id);
  const snapshot = await matchRef.get();
  if(!snapshot.exists()) return alert('Match not found');

  state.matchRef = matchRef;
  matchSection.hidden = true;
  gameSection.hidden = false;

  await matchRef.child('players/' + state.playerId).set({name:state.playerName,score:0,choice:null});
  matchRef.on('value', snap => handleMatchUpdate(snap.val()));
  renderChoices();
};

// Choices
function renderChoices() {
  choicesDiv.innerHTML='';
  state.choices.forEach(key=>{
    const item=items[key];
    const btn=document.createElement('button');
    btn.className='choice';
    btn.textContent=item.icon;
    const label=document.createElement('div');
    label.className='choice-label';
    label.textContent=item.name;
    btn.appendChild(label);
    btn.onclick=()=>makeChoice(key);
    choicesDiv.appendChild(btn);
  });
}

function makeChoice(key){
  if(!state.matchRef) return;
  state.playerChoice=key;
  disableChoices(true);
  state.matchRef.child('players/'+state.playerId+'/choice').set(key);
  statusText.textContent='Choice made! Waiting for opponent...';
}

// Match Update
function handleMatchUpdate(data){
  if(!data) return;
  const players = data.players||{};
  let opponentId = Object.keys(players).find(pid=>pid!==state.playerId);

  if(opponentId){
    opponentNameLabel.textContent = players[opponentId].name;
    state.opponentScore = players[opponentId].score||0;
    opponentScoreEl.textContent = state.opponentScore;
  }

  const playerData = players[state.playerId];
  const opponentData = opponentId?players[opponentId]:null;
  if(playerData && opponentData){
    if(playerData.choice && opponentData.choice) resolveRound(playerData.choice, opponentData.choice);
  }
}

// Battle Logic
function getResult(p1,p2){
  if(p1===p2) return 'tie';
  return items[p1].beats.includes(p2)?'win':'lose';
}

function resolveRound(playerKey,opponentKey){
  const result = getResult(playerKey,opponentKey);
  const playerCardFront = playerCardInner.querySelector('.card-front');
  const opponentCardFront = opponentCardInner.querySelector('.card-front');

  playerCardFront.textContent = items[playerKey].icon;
  opponentCardFront.textContent = items[opponentKey].icon;

  if(result==='win'){statusText.textContent='You Win!';state.playerScore++;playerScoreEl.textContent=state.playerScore;}
  else if(result==='lose'){statusText.textContent='You Lose!';state.opponentScore++;opponentScoreEl.textContent=state.opponentScore;}
  else{statusText.textContent='Tie!';}

  setTimeout(()=>{
    if(state.matchRef) state.matchRef.child('players/'+state.playerId+'/choice').set(null);
    disableChoices(false);
    statusText.textContent='Make your choice!';
    playerCardFront.textContent='?';
    opponentCardFront.textContent='?';
  },2000);
}

function disableChoices(disabled){
  Array.from(choicesDiv.children).forEach(btn=>btn.disabled=disabled);
}

// Leave Match
btnLeaveMatch.onclick=()=>{
  if(!state.matchRef) return;
  state.matchRef.child('players/'+state.playerId).remove();
  state.matchRef=null; state.matchId=null;
  gameSection.hidden=true; matchSection.hidden=false;
  matchStatus.textContent='';
  playerCardInner.querySelector('.card-front').textContent='?';
  opponentCardInner.querySelector('.card-front').textContent='?';
  playerScoreEl.textContent='0'; opponentScoreEl.textContent='0';
};

</script>
</body>
</html>
