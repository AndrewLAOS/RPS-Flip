<script type="module">
import { items } from './items.js';

// --- State ---
let playerCoins = 100;
let botInventory = [];
let botDifficulty = 50;
const choices = ["Rock", "Paper", "Scissors", "Flip"];

// --- DOM Elements ---
const battleChoicesEl = document.getElementById('battle-choices');
const battleStatusEl = document.getElementById('battle-status');
const shopItemsEl = document.getElementById('shop-items');
const shopStatusEl = document.getElementById('shop-status');
const botInventoryEl = document.getElementById('bot-inventory-items');
const difficultySlider = document.getElementById('bot-difficulty-slider');
const difficultyLabel = document.getElementById('bot-difficulty-label');

// --- Navigation ---
const screens = document.querySelectorAll('.screen');
document.querySelectorAll('nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    // switch aria-selected
    document.querySelectorAll('nav button').forEach(b => {
      b.setAttribute('aria-selected', 'false');
      b.tabIndex = -1;
    });
    btn.setAttribute('aria-selected', 'true');
    btn.tabIndex = 0;

    // switch screens
    screens.forEach(screen => {
      if (screen.id === btn.getAttribute('aria-controls')) {
        screen.classList.add('active');
        screen.removeAttribute('hidden');
      } else {
        screen.classList.remove('active');
        screen.setAttribute('hidden', '');
      }
    });
  });
});

// --- Battle UI ---
function renderChoices() {
  battleChoicesEl.innerHTML = '';
  choices.forEach(choice => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = choice;
    btn.addEventListener('click', () => handleBattle(choice));
    battleChoicesEl.appendChild(btn);
  });
}

function handleBattle(playerChoice) {
  const botChoice = botPick();
  const result = getResult(playerChoice, botChoice);
  battleStatusEl.textContent = `You chose ${playerChoice}, Bot chose ${botChoice}. ${result}`;
}

function botPick() {
  // Bot difficulty affects predictability
  if (Math.random() * 100 < botDifficulty) {
    // Bot tries to counter playerâ€™s last choice
    return choices[Math.floor(Math.random() * choices.length)];
  }
  return choices[Math.floor(Math.random() * choices.length)];
}

function getResult(player, bot) {
  if (player === bot) return "It's a tie!";
  if (
    (player === "Rock" && bot === "Scissors") ||
    (player === "Paper" && bot === "Rock") ||
    (player === "Scissors" && bot === "Paper") ||
    (player === "Flip" && Math.random() > 0.5)
  ) {
    playerCoins += 10;
    return "You win!";
  } else {
    playerCoins -= 5;
    return "You lose!";
  }
}

// --- Shop ---
function renderShop() {
  shopItemsEl.innerHTML = '';
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'shop-item';

    const icon = document.createElement('div');
    icon.className = 'shop-icon';
    icon.textContent = item.icon;

    const name = document.createElement('div');
    name.className = 'shop-name';
    name.textContent = item.name;

    const rarity = document.createElement('div');
    rarity.className = 'shop-rarity';
    rarity.textContent = item.rarity;

    const cost = document.createElement('div');
    cost.className = 'shop-cost';
    cost.textContent = `${item.cost} coins`;

    const btn = document.createElement('button');
    btn.textContent = "Buy";
    btn.disabled = playerCoins < item.cost;
    btn.addEventListener('click', () => buyItem(item));

    div.append(icon, name, rarity, cost, btn);
    shopItemsEl.appendChild(div);
  });
}

function buyItem(item) {
  if (playerCoins >= item.cost) {
    playerCoins -= item.cost;
    botInventory.push(item);
    shopStatusEl.textContent = `Bought ${item.name}!`;
    renderShop();
    renderBotInventory();
  } else {
    shopStatusEl.textContent = `Not enough coins!`;
  }
}

// --- Bot Inventory ---
function renderBotInventory() {
  botInventoryEl.innerHTML = '';
  botInventory.forEach(item => {
    const div = document.createElement('div');
    div.className = 'inventory-item';

    const icon = document.createElement('div');
    icon.className = 'inventory-icon';
    icon.textContent = item.icon;

    const name = document.createElement('div');
    name.className = 'inventory-name';
    name.textContent = item.name;

    const rarity = document.createElement('div');
    rarity.className = 'inventory-rarity';
    rarity.textContent = item.rarity;

    div.append(icon, name, rarity);
    botInventoryEl.appendChild(div);
  });
}

// --- Difficulty Control ---
difficultySlider.addEventListener('input', () => {
  botDifficulty = Number(difficultySlider.value);
  difficultyLabel.textContent = `${botDifficulty}%`;
});

// --- Init ---
renderChoices();
renderShop();
renderBotInventory();
</script>
